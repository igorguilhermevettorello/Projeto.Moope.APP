<div class="container mt-3">
  <div class="row">
    <div class="col-12">
      <h4>{{ isEditMode ? 'Editar Cliente' : 'Adicionar Cliente' }}</h4>
      
      <!-- Navegação das abas -->
      <ul class="nav nav-tabs" id="clienteTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab === 'dados-pessoais'"
            [class.text-success]="isTabValid('dados-pessoais') && activeTab !== 'dados-pessoais'"
            type="button" 
            (click)="setActiveTab('dados-pessoais')">
            <i class="bi bi-person"></i>
            Dados Pessoais
            <i class="bi bi-check-circle-fill text-success ms-1" *ngIf="isTabValid('dados-pessoais') && activeTab !== 'dados-pessoais'"></i>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab === 'endereco'"
            [class.text-success]="isTabValid('endereco') && activeTab !== 'endereco'"
            type="button" 
            (click)="setActiveTab('endereco')">
            <i class="bi bi-geo-alt"></i>
            Endereço
            <i class="bi bi-check-circle-fill text-success ms-1" *ngIf="isTabValid('endereco') && activeTab !== 'endereco'"></i>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button 
            class="nav-link" 
            [class.active]="activeTab === 'dados-conta'"
            [class.text-success]="isTabValid('dados-conta') && activeTab !== 'dados-conta'"
            type="button" 
            (click)="setActiveTab('dados-conta')">
            <i class="bi bi-person-gear"></i>
            Dados da Conta
            <i class="bi bi-check-circle-fill text-success ms-1" *ngIf="isTabValid('dados-conta') && activeTab !== 'dados-conta'"></i>
          </button>
        </li>
        <li class="nav-item" role="presentation" *ngIf="!isEditMode">
          <button 
            class="nav-link" 
            [class.active]="activeTab === 'dados-acesso'"
            [class.text-success]="isTabValid('dados-acesso') && activeTab !== 'dados-acesso'"
            type="button" 
            (click)="setActiveTab('dados-acesso')">
            <i class="bi bi-key"></i>
            Dados de Acesso
            <i class="bi bi-check-circle-fill text-success ms-1" *ngIf="isTabValid('dados-acesso') && activeTab !== 'dados-acesso'"></i>
          </button>
        </li>
      </ul>

      <form [formGroup]="clienteForm" (ngSubmit)="salvar()">
        
        <!-- Aba Dados Pessoais -->
        <div class="tab-content" *ngIf="activeTab === 'dados-pessoais'">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label for="nome" class="form-label">Nome Completo *</label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                [class.is-invalid]="nome?.invalid && nome?.touched"
                id="nome" 
                placeholder="Digite o nome completo"
                formControlName="nome"
                required>
              <div class="invalid-feedback" *ngIf="nome?.invalid && nome?.touched">
                <div *ngIf="nome?.errors?.['required']">Nome é obrigatório</div>
                <div *ngIf="nome?.errors?.['minlength']">Nome deve ter pelo menos 2 caracteres</div>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label for="tipoPessoa" class="form-label">Tipo de Pessoa *</label>
              <select 
                class="form-select form-select-sm" 
                [class.is-invalid]="tipoPessoa?.invalid && tipoPessoa?.touched"
                id="tipoPessoa" 
                formControlName="tipoPessoa"
                required>
                <option value="">Selecione o tipo de pessoa</option>
                <option *ngFor="let tipo of tiposPessoa" [value]="tipo.value">{{ tipo.label }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="tipoPessoa?.invalid && tipoPessoa?.touched">
                <div *ngIf="tipoPessoa?.errors?.['required']">Tipo de pessoa é obrigatório</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="email" class="form-label">Email *</label>
              <input 
                type="email" 
                class="form-control form-control-sm" 
                [class.is-invalid]="email?.invalid && email?.touched"
                id="email" 
                placeholder="Digite o email"
                formControlName="email"
                required>
              <div class="invalid-feedback" *ngIf="email?.invalid && email?.touched">
                <div *ngIf="email?.errors?.['required']">Email é obrigatório</div>
                <div *ngIf="email?.errors?.['email']">Email deve ter um formato válido</div>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="cpfCnpj" class="form-label">
                {{ labelCpfCnpj }} *
              </label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                [class.is-invalid]="cpfCnpj?.invalid && cpfCnpj?.touched"
                id="cpfCnpj" 
                [placeholder]="placeholderCpfCnpj"
                [maxlength]="tipoPessoa?.value === '1' ? 14 : 18"
                formControlName="cpfCnpj"
                (input)="aplicarMascaraCpfCnpj($event)"
                required>
              <div class="invalid-feedback" *ngIf="cpfCnpj?.invalid && cpfCnpj?.touched">
                <div *ngIf="cpfCnpj?.errors?.['required']">{{ tipoPessoa?.value === '1' ? 'CPF' : 'CNPJ' }} é obrigatório</div>
                <div *ngIf="cpfCnpj?.errors?.['cpfInvalido']">CPF inválido</div>
                <div *ngIf="cpfCnpj?.errors?.['cnpjInvalido']">CNPJ inválido</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="telefone" class="form-label">Telefone *</label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                [class.is-invalid]="telefone?.invalid && telefone?.touched"
                id="telefone" 
                placeholder="(00) 00000-0000"
                formControlName="telefone"
                (input)="aplicarMascaraTelefone($event)"
                required>
              <div class="invalid-feedback" *ngIf="telefone?.invalid && telefone?.touched">
                <div *ngIf="telefone?.errors?.['required']">Telefone é obrigatório</div>
              </div>
            </div>


          </div>
        </div>

        <!-- Aba Endereço -->
        <div class="tab-content" *ngIf="activeTab === 'endereco'">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="cep" class="form-label">CEP *</label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control form-control-sm" 
                  [class.is-invalid]="cep?.invalid && cep?.touched"
                  id="cep" 
                  placeholder="00000-000"
                  formControlName="cep"
                  (input)="aplicarMascaraCep($event)"
                  (blur)="buscarCep()"
                  required>
                <button 
                  class="btn btn-outline-secondary" 
                  type="button" 
                  (click)="buscarCep()"
                  [disabled]="!cep?.value || cep?.invalid">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="invalid-feedback" *ngIf="cep?.invalid && cep?.touched">
                <div *ngIf="cep?.errors?.['required']">CEP é obrigatório</div>
                <div *ngIf="cep?.errors?.['pattern']">CEP deve ter formato 00000-000</div>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="logradouro" class="form-label">Endereço *</label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                [class.is-invalid]="logradouro?.invalid && logradouro?.touched"
                id="logradouro" 
                placeholder="Digite o endereço"
                formControlName="logradouro"
                required>
              <div class="invalid-feedback" *ngIf="logradouro?.invalid && logradouro?.touched">
                <div *ngIf="logradouro?.errors?.['required']">Endereço é obrigatório</div>
                <div *ngIf="logradouro?.errors?.['minlength']">Endereço deve ter pelo menos 2 caracteres</div>
              </div>
            </div>

            <div class="col-md-2 mb-3">
              <label for="numero" class="form-label">Número *</label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                [class.is-invalid]="numero?.invalid && numero?.touched"
                id="numero" 
                placeholder="Nº"
                formControlName="numero"
                required>
              <div class="invalid-feedback" *ngIf="numero?.invalid && numero?.touched">
                <div *ngIf="numero?.errors?.['required']">Número é obrigatório</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="bairro" class="form-label">Bairro *</label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                [class.is-invalid]="bairro?.invalid && bairro?.touched"
                id="bairro" 
                placeholder="Digite o bairro"
                formControlName="bairro"
                required>
              <div class="invalid-feedback" *ngIf="bairro?.invalid && bairro?.touched">
                <div *ngIf="bairro?.errors?.['required']">Bairro é obrigatório</div>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label for="cidade" class="form-label">Cidade *</label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                [class.is-invalid]="cidade?.invalid && cidade?.touched"
                id="cidade" 
                placeholder="Digite a cidade"
                formControlName="cidade"
                required>
              <div class="invalid-feedback" *ngIf="cidade?.invalid && cidade?.touched">
                <div *ngIf="cidade?.errors?.['required']">Cidade é obrigatória</div>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label for="estado" class="form-label">UF *</label>
              <select 
                class="form-select form-select-sm" 
                [class.is-invalid]="estado?.invalid && estado?.touched"
                id="estado" 
                formControlName="estado"
                required>
                <option value="">Selecione o estado</option>
                <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="estado?.invalid && estado?.touched">
                <div *ngIf="estado?.errors?.['required']">UF é obrigatório</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="complemento" class="form-label">Complemento</label>
              <input 
                type="text" 
                class="form-control form-control-sm" 
                id="complemento" 
                placeholder="Apartamento, bloco, etc. (opcional)"
                formControlName="complemento">
            </div>
          </div>
        </div>

        <!-- Aba Dados da Conta -->
        <div class="tab-content" *ngIf="activeTab === 'dados-conta'">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="statusConta" class="form-label">Status da Conta</label>
              <div class="form-check mt-2">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="statusConta" 
                  formControlName="status">
                <label class="form-check-label" for="statusConta">
                  <span class="fw-semibold" [class.text-success]="status?.value" [class.text-danger]="!status?.value">
                    {{ status?.value ? 'Cliente Ativo' : 'Cliente Inativo' }}
                  </span>
                </label>
              </div>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle"></i>
                Clientes inativos não poderão acessar o sistema
              </small>
            </div>
            
            <div class="col-md-6 mb-3" *ngIf="isEditMode">
              <label class="form-label">Informações da Conta</label>
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-calendar3 me-2 text-primary"></i>
                    <span class="small">
                      <strong>Data de Cadastro:</strong> 
                      <span *ngIf="clienteInfo?.dataCadastro; else semDataCadastro">
                        {{ clienteInfo.dataCadastro | date:'dd/MM/yyyy HH:mm' }}
                      </span>
                      <ng-template #semDataCadastro>Não informado</ng-template>
                    </span>
                  </div>
                  <div class="d-flex align-items-center">
                    <i class="bi bi-clock-history me-2 text-primary"></i>
                    <span class="small">
                      <strong>Última Atualização:</strong> 
                      <span *ngIf="clienteInfo?.dataAtualizacao; else semDataAtualizacao">
                        {{ clienteInfo.dataAtualizacao | date:'dd/MM/yyyy HH:mm' }}
                      </span>
                      <ng-template #semDataAtualizacao>Não informado</ng-template>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Aba Dados de Acesso -->
        <div class="tab-content" *ngIf="activeTab === 'dados-acesso' && !isEditMode">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="senha" class="form-label">Senha *</label>
              <input 
                type="password" 
                class="form-control form-control-sm" 
                [class.is-invalid]="senha?.invalid && senha?.touched"
                id="senha" 
                placeholder="Digite a senha"
                formControlName="senha"
                required>
              <div class="invalid-feedback" *ngIf="senha?.invalid && senha?.touched">
                <div *ngIf="senha?.errors?.['required']">Senha é obrigatória</div>
                <div *ngIf="senha?.errors?.['minlength']">Senha deve ter pelo menos 6 caracteres</div>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="confirmarSenha" class="form-label">Confirmar Senha *</label>
              <input 
                type="password" 
                class="form-control form-control-sm" 
                [class.is-invalid]="(confirmarSenha?.invalid && confirmarSenha?.touched) || clienteForm.errors?.['senhasDiferentes']"
                id="confirmarSenha" 
                placeholder="Confirme a senha"
                formControlName="confirmarSenha"
                required>
              <div class="invalid-feedback" *ngIf="(confirmarSenha?.invalid && confirmarSenha?.touched) || clienteForm.errors?.['senhasDiferentes']">
                <div *ngIf="confirmarSenha?.errors?.['required']">Confirmação de senha é obrigatória</div>
                <div *ngIf="clienteForm.errors?.['senhasDiferentes']">As senhas devem ser iguais</div>
              </div>
            </div>
          </div>

          <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>Informação:</strong> A senha será usada pelo cliente para acessar o sistema.
          </div>
        </div>

        <!-- Botões de navegação e ação -->
        <div class="d-flex justify-content-end align-items-center mt-4">
          <div>
            <button 
              type="button" 
              class="btn btn-outline-primary me-2" 
              (click)="salvar()"
              [disabled]="isLoading">
              <i class="bi bi-save"></i> Salvar
            </button>
            <button 
              type="button" 
              class="btn btn-outline-danger" 
              (click)="cancelar()"
              [disabled]="isLoading">
              <i class="bi bi-trash"></i>Cancelar 
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>